<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Memory Graph Visualizer</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    :root {
      --bg: #0f1117;
      --surface: #1a1d27;
      --surface2: #232736;
      --border: #2e3348;
      --text: #e1e4ed;
      --text-muted: #8b90a0;
      --accent: #6c7bf7;
      --accent-dim: #4a56c9;
      --orange: #f59e0b;
      --green: #34d399;
      --red: #f87171;
      --cyan: #22d3ee;
      --pink: #f472b6;
      --purple: #a78bfa;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'SF Mono', 'Cascadia Code', 'Fira Code', 'JetBrains Mono', monospace;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
    }

    .app { display: grid; grid-template-rows: auto 1fr; height: 100vh; }

    header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 24px; background: var(--surface); border-bottom: 1px solid var(--border);
    }
    header h1 { font-size: 16px; font-weight: 600; color: var(--accent); letter-spacing: -0.3px; }
    header h1 span { color: var(--text-muted); font-weight: 400; }

    .header-actions { display: flex; align-items: center; gap: 10px; }

    .file-path {
      font-size: 12px; color: var(--text-muted); background: var(--surface2);
      padding: 4px 10px; border-radius: 4px; max-width: 350px;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }

    .btn {
      padding: 6px 14px; border-radius: 6px; border: 1px solid var(--border);
      background: var(--surface2); color: var(--text); font-size: 12px;
      font-family: inherit; cursor: pointer; transition: all 0.15s;
    }
    .btn:hover { background: var(--border); }
    .btn-primary { background: var(--accent); border-color: var(--accent); color: #fff; }
    .btn-primary:hover { background: var(--accent-dim); }
    .btn-save { background: var(--green); border-color: var(--green); color: #0f1117; font-weight: 600; }
    .btn-save:hover { opacity: 0.85; }
    .btn-save:disabled { opacity: 0.3; cursor: default; }

    .stats { display: flex; gap: 16px; font-size: 12px; color: var(--text-muted); }
    .stats strong { color: var(--text); }

    .content { display: grid; grid-template-columns: 1fr 1fr; overflow: hidden; }
    .panel { display: flex; flex-direction: column; overflow: hidden; border-right: 1px solid var(--border); }
    .panel:last-child { border-right: none; }

    .panel-tabs { display: flex; border-bottom: 1px solid var(--border); background: var(--surface); }
    .panel-tab {
      padding: 8px 16px; font-size: 12px; font-family: inherit; color: var(--text-muted);
      background: none; border: none; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.15s;
    }
    .panel-tab:hover { color: var(--text); }
    .panel-tab.active { color: var(--accent); border-bottom-color: var(--accent); }

    .panel-body { flex: 1; overflow: auto; padding: 0; }

    /* JSONL View */
    .jsonl-view { padding: 16px; font-size: 13px; line-height: 1.7; white-space: pre-wrap; word-break: break-word; }
    .jsonl-line {
      padding: 4px 8px; border-radius: 4px; margin-bottom: 2px;
      cursor: pointer; transition: background 0.1s; border: 1px solid transparent;
    }
    .jsonl-line:hover { background: var(--surface2); }
    .jsonl-line.selected { background: var(--surface2); border-color: var(--accent); }

    .json-key { color: var(--cyan); }
    .json-string { color: var(--green); }
    .json-type { color: var(--orange); }
    .json-bracket { color: var(--text-muted); }
    .json-relation { color: var(--pink); }

    /* JSONL Edit Mode */
    .jsonl-editor {
      width: 100%; min-height: 60px; background: var(--bg); color: var(--green);
      border: 1px solid var(--accent); border-radius: 4px; padding: 6px 8px;
      font-family: inherit; font-size: 12px; line-height: 1.6; resize: vertical;
    }
    .jsonl-editor:focus { outline: none; border-color: var(--cyan); }
    .jsonl-edit-actions { display: flex; gap: 6px; margin-top: 4px; }
    .jsonl-edit-actions .btn { padding: 3px 10px; font-size: 11px; }
    .jsonl-error { color: var(--red); font-size: 11px; margin-top: 2px; }

    /* Tree View */
    .tree-view { padding: 16px; font-size: 13px; }
    .tree-node { margin-bottom: 8px; }
    .tree-header {
      display: flex; align-items: center; gap: 8px; padding: 6px 10px;
      border-radius: 6px; cursor: pointer; transition: background 0.1s; border: 1px solid transparent;
    }
    .tree-header:hover { background: var(--surface2); }
    .tree-header.selected { background: var(--surface2); border-color: var(--accent); }

    .tree-toggle { width: 16px; text-align: center; color: var(--text-muted); font-size: 10px; flex-shrink: 0; user-select: none; }
    .tree-icon { font-size: 14px; flex-shrink: 0; }
    .tree-name { font-weight: 600; color: var(--text); flex: 1; }
    .tree-type {
      font-size: 11px; color: var(--orange); background: rgba(245, 158, 11, 0.12);
      padding: 1px 6px; border-radius: 3px;
    }
    .tree-edit-btn {
      font-size: 11px; color: var(--text-muted); background: none; border: none;
      cursor: pointer; opacity: 0; transition: opacity 0.15s; padding: 2px 6px;
    }
    .tree-header:hover .tree-edit-btn { opacity: 1; }
    .tree-edit-btn:hover { color: var(--accent); }

    .tree-children { margin-left: 24px; border-left: 1px solid var(--border); padding-left: 12px; overflow: hidden; }
    .tree-children.collapsed { max-height: 0; padding: 0; overflow: hidden; }

    .tree-section-label {
      font-size: 10px; font-weight: 700; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 1px; padding: 8px 0 4px;
    }

    .tree-observation { font-size: 12px; color: var(--text-muted); padding: 3px 0; line-height: 1.5; display: flex; align-items: flex-start; gap: 4px; }
    .tree-observation .bullet { color: var(--border); flex-shrink: 0; }
    .tree-observation .obs-text { flex: 1; }
    .tree-obs-edit, .tree-obs-delete {
      font-size: 10px; color: var(--text-muted); background: none; border: none;
      cursor: pointer; opacity: 0; transition: opacity 0.1s; padding: 0 3px;
    }
    .tree-observation:hover .tree-obs-edit,
    .tree-observation:hover .tree-obs-delete { opacity: 1; }
    .tree-obs-edit:hover { color: var(--accent); }
    .tree-obs-delete:hover { color: var(--red); }

    .tree-relation { font-size: 12px; padding: 3px 0; }
    .tree-relation-arrow { color: var(--pink); }
    .tree-relation-type { color: var(--purple); font-style: italic; }
    .tree-relation-target { color: var(--cyan); }

    .tree-inline-input {
      background: var(--bg); color: var(--text); border: 1px solid var(--accent);
      border-radius: 3px; padding: 2px 6px; font-family: inherit; font-size: 12px; width: 100%;
    }
    .tree-inline-input:focus { outline: none; border-color: var(--cyan); }
    .tree-add-obs {
      font-size: 11px; color: var(--text-muted); background: none; border: none;
      cursor: pointer; padding: 4px 0; margin-top: 2px;
    }
    .tree-add-obs:hover { color: var(--accent); }

    /* Graph View */
    .graph-container { width: 100%; height: 100%; position: relative; }
    .graph-container svg { width: 100%; height: 100%; }
    .graph-link { stroke: var(--border); stroke-width: 1.5; }
    .graph-link.highlight { stroke: var(--accent); stroke-width: 2.5; }
    .graph-link-label { font-size: 10px; fill: var(--text-muted); text-anchor: middle; pointer-events: none; }
    .graph-node circle { stroke-width: 2; cursor: pointer; transition: all 0.15s; }
    .graph-node.selected circle { stroke-width: 3; r: 22; filter: drop-shadow(0 0 8px var(--accent)); }
    .graph-node.dimmed circle { opacity: 0.25; }
    .graph-node.dimmed text { opacity: 0.25; }
    .graph-link.dimmed { opacity: 0.1; }
    .graph-node text { font-size: 11px; font-family: inherit; fill: var(--text); text-anchor: middle; pointer-events: none; }
    .graph-arrow { fill: var(--border); }

    .tooltip {
      position: fixed; max-width: 380px; background: var(--surface); border: 1px solid var(--border);
      border-radius: 8px; padding: 12px 16px; font-size: 12px; line-height: 1.6;
      pointer-events: none; opacity: 0; transition: opacity 0.15s; z-index: 100;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    }
    .tooltip.visible { opacity: 1; }
    .tooltip-title { font-weight: 600; color: var(--accent); margin-bottom: 4px; }
    .tooltip-type { color: var(--orange); font-size: 11px; }
    .tooltip-obs { color: var(--text-muted); margin-top: 6px; }

    .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; gap: 16px; color: var(--text-muted); }
    .empty-state svg { opacity: 0.3; }
    .empty-state p { font-size: 14px; }

    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div style="display:flex;align-items:center;gap:16px;">
        <h1>Memory Graph <span>Visualizer</span></h1>
        <div class="stats" id="stats"></div>
      </div>
      <div class="header-actions">
        <span class="file-path" id="filePath">No file loaded</span>
        <button class="btn" onclick="document.getElementById('fileInput').click()">Open JSONL</button>
        <button class="btn btn-save" id="saveBtn" disabled onclick="saveFile()">Save</button>
        <input type="file" id="fileInput" accept=".jsonl,.json" hidden>
      </div>
    </header>

    <div class="content">
      <div class="panel">
        <div class="panel-tabs">
          <button class="panel-tab active" data-panel="left" data-view="jsonl">JSONL</button>
          <button class="panel-tab" data-panel="left" data-view="tree">Tree</button>
        </div>
        <div class="panel-body">
          <div id="jsonl-view" class="jsonl-view"></div>
          <div id="tree-view" class="tree-view" style="display:none;"></div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-tabs">
          <button class="panel-tab active" data-panel="right" data-view="graph">Graph</button>
        </div>
        <div class="panel-body">
          <div id="graph-view" class="graph-container"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="tooltip" id="tooltip"></div>

  <script>
    let graphData = { entities: [], relations: [] };
    let rawLines = [];
    let simulation = null;
    let selectedEntity = null;
    let dirty = false;
    let activeLeftView = 'jsonl';
    let loadedFileHandle = null;

    function markDirty() {
      dirty = true;
      document.getElementById('saveBtn').disabled = false;
    }

    // Rebuild rawLines from graphData
    function rebuildRawLines() {
      rawLines = [
        ...graphData.entities.map(e => JSON.stringify(e)),
        ...graphData.relations.map(r => JSON.stringify(r)),
      ];
    }

    function updateStats() {
      document.getElementById('stats').innerHTML =
        `<span><strong>${graphData.entities.length}</strong> entities</span>` +
        `<span><strong>${graphData.relations.length}</strong> relations</span>` +
        `<span><strong>${graphData.entities.reduce((s, e) => s + (e.observations || []).length, 0)}</strong> observations</span>`;
    }

    // Tab switching
    document.querySelectorAll('.panel-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const panel = tab.dataset.panel;
        const view = tab.dataset.view;
        document.querySelectorAll(`.panel-tab[data-panel="${panel}"]`).forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        if (panel === 'left') {
          activeLeftView = view;
          document.getElementById('jsonl-view').style.display = view === 'jsonl' ? 'block' : 'none';
          document.getElementById('tree-view').style.display = view === 'tree' ? 'block' : 'none';
          syncSelection(selectedEntity);
        }
      });
    });

    // File input
    document.getElementById('fileInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      loadedFileHandle = file;
      const text = await file.text();
      document.getElementById('filePath').textContent = file.name;
      parseAndRender(text);
    });

    // Save: download updated file
    function saveFile() {
      if (!dirty) return;
      rebuildRawLines();
      const content = rawLines.join('\n') + '\n';
      const blob = new Blob([content], { type: 'application/jsonl' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = loadedFileHandle ? loadedFileHandle.name : 'memory.jsonl';
      a.click();
      URL.revokeObjectURL(a.href);
      dirty = false;
      document.getElementById('saveBtn').disabled = true;
    }

    // Parse
    function parseAndRender(text) {
      rawLines = text.trim().split('\n').filter(Boolean);
      graphData = { entities: [], relations: [] };
      rawLines.forEach(line => {
        try {
          const obj = JSON.parse(line);
          if (obj.type === 'entity') graphData.entities.push(obj);
          else if (obj.type === 'relation') graphData.relations.push(obj);
        } catch {}
      });
      dirty = false;
      document.getElementById('saveBtn').disabled = true;
      updateStats();
      renderJsonl();
      renderTree();
      renderGraph();
    }

    // --- Selection Sync ---
    function selectEntity(name) {
      selectedEntity = selectedEntity === name ? null : name;
      syncSelection(selectedEntity);
    }

    function syncSelection(name) {
      // JSONL
      document.querySelectorAll('.jsonl-line').forEach(el => {
        el.classList.toggle('selected', name && el.dataset.entity === name);
      });
      // Tree
      document.querySelectorAll('.tree-header').forEach(el => {
        el.classList.toggle('selected', name && el.dataset.entity === name);
      });
      // Expand selected tree node
      if (name) {
        const treeId = 'tree-' + name.replace(/\s+/g, '-');
        const el = document.getElementById(treeId);
        if (el && el.classList.contains('collapsed')) {
          el.classList.remove('collapsed');
          const toggle = document.getElementById(treeId + '-toggle');
          if (toggle) toggle.innerHTML = '&#9660;';
        }
      }
      // Graph
      syncGraphSelection(name);
      // Scroll into view
      if (name && activeLeftView === 'jsonl') {
        const el = document.querySelector(`.jsonl-line.selected`);
        if (el) el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      } else if (name && activeLeftView === 'tree') {
        const el = document.querySelector(`.tree-header.selected`);
        if (el) el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    }

    // --- JSONL View ---
    function renderJsonl() {
      rebuildRawLines();
      const container = document.getElementById('jsonl-view');
      container.innerHTML = rawLines.map((line, i) => {
        let entityName = '';
        try {
          const obj = JSON.parse(line);
          entityName = obj.name || obj.from || '';
        } catch {}
        const highlighted = highlightJson(line);
        return `<div class="jsonl-line" data-line="${i}" data-entity="${esc(entityName)}" onclick="handleJsonlClick(this, ${i})">${highlighted}</div>`;
      }).join('');
    }

    let editingJsonlLine = -1;

    function handleJsonlClick(el, lineIdx) {
      const entityName = el.dataset.entity;
      if (entityName) selectEntity(entityName);
    }

    function startJsonlEdit(lineIdx) {
      editingJsonlLine = lineIdx;
      const container = document.getElementById('jsonl-view');
      const lineEl = container.querySelector(`[data-line="${lineIdx}"]`);
      if (!lineEl) return;
      const raw = rawLines[lineIdx];
      let pretty;
      try { pretty = JSON.stringify(JSON.parse(raw), null, 2); } catch { pretty = raw; }
      lineEl.innerHTML = `
        <textarea class="jsonl-editor" id="jsonl-edit-area">${esc(pretty)}</textarea>
        <div class="jsonl-error" id="jsonl-edit-error"></div>
        <div class="jsonl-edit-actions">
          <button class="btn btn-primary" onclick="applyJsonlEdit(${lineIdx})">Apply</button>
          <button class="btn" onclick="cancelJsonlEdit()">Cancel</button>
        </div>
      `;
      const textarea = document.getElementById('jsonl-edit-area');
      textarea.style.height = textarea.scrollHeight + 'px';
      textarea.focus();
    }

    function applyJsonlEdit(lineIdx) {
      const textarea = document.getElementById('jsonl-edit-area');
      const errorEl = document.getElementById('jsonl-edit-error');
      try {
        const obj = JSON.parse(textarea.value);
        rawLines[lineIdx] = JSON.stringify(obj);
        // Rebuild graphData from rawLines
        graphData = { entities: [], relations: [] };
        rawLines.forEach(line => {
          try {
            const o = JSON.parse(line);
            if (o.type === 'entity') graphData.entities.push(o);
            else if (o.type === 'relation') graphData.relations.push(o);
          } catch {}
        });
        markDirty();
        updateStats();
        renderJsonl();
        renderTree();
        renderGraph();
        editingJsonlLine = -1;
      } catch (e) {
        errorEl.textContent = 'Invalid JSON: ' + e.message;
      }
    }

    function cancelJsonlEdit() {
      editingJsonlLine = -1;
      renderJsonl();
    }

    // Add double-click to edit JSONL lines
    document.getElementById('jsonl-view').addEventListener('dblclick', (e) => {
      const line = e.target.closest('.jsonl-line');
      if (line) startJsonlEdit(Number(line.dataset.line));
    });

    function highlightJson(str) {
      return str
        .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
        .replace(/"(type)":/g, '"<span class="json-key">$1</span>":')
        .replace(/"(name|entityType|from|to|relationType|observations)":/g, '"<span class="json-key">$1</span>":')
        .replace(/:\s*"(entity|relation)"/g, ': "<span class="json-type">$1</span>"')
        .replace(/:\s*"(project|architecture|schema|convention)"/g, ': "<span class="json-type">$1</span>"')
        .replace(/"(has|contains|follows|references[^"]*)"/, '"<span class="json-relation">$1</span>"')
        .replace(/("(?:(?!":).)*?")/g, (match) => {
          if (match.includes('class="')) return match;
          return `<span class="json-string">${match}</span>`;
        })
        .replace(/([{}\[\]])/g, '<span class="json-bracket">$1</span>');
    }

    // --- Tree View ---
    function renderTree() {
      const container = document.getElementById('tree-view');
      const relsByEntity = {};
      graphData.relations.forEach(r => {
        if (!relsByEntity[r.from]) relsByEntity[r.from] = [];
        relsByEntity[r.from].push(r);
      });

      let html = '';
      graphData.entities.forEach((entity, entityIdx) => {
        const rels = relsByEntity[entity.name] || [];
        const id = `tree-${entity.name.replace(/\s+/g, '-')}`;
        const isSelected = selectedEntity === entity.name;
        html += `
          <div class="tree-node" data-entity-idx="${entityIdx}">
            <div class="tree-header ${isSelected ? 'selected' : ''}" data-entity="${esc(entity.name)}" onclick="handleTreeHeaderClick(this, '${esc(entity.name)}')" ondblclick="startTreeNameEdit(${entityIdx})">
              <span class="tree-toggle" id="${id}-toggle" onclick="event.stopPropagation(); toggleTree('${id}')">&#9660;</span>
              <span class="tree-icon">${getEntityIcon(entity.entityType)}</span>
              <span class="tree-name" id="${id}-name">${esc(entity.name)}</span>
              <span class="tree-type">${esc(entity.entityType)}</span>
              <button class="tree-edit-btn" onclick="event.stopPropagation(); startTreeNameEdit(${entityIdx})" title="Edit">&#9998;</button>
            </div>
            <div class="tree-children" id="${id}">
              ${entity.observations && entity.observations.length > 0 ? `
                <div class="tree-section-label">Observations (${entity.observations.length})</div>
                ${entity.observations.map((o, oi) => `
                  <div class="tree-observation">
                    <span class="bullet">&#8226;</span>
                    <span class="obs-text" id="obs-${entityIdx}-${oi}">${esc(o)}</span>
                    <button class="tree-obs-edit" onclick="startObsEdit(${entityIdx}, ${oi})" title="Edit">&#9998;</button>
                    <button class="tree-obs-delete" onclick="deleteObs(${entityIdx}, ${oi})" title="Delete">&#10005;</button>
                  </div>
                `).join('')}
              ` : '<div class="tree-section-label">Observations (0)</div>'}
              <button class="tree-add-obs" onclick="addObs(${entityIdx})">+ Add observation</button>
              ${rels.length > 0 ? `
                <div class="tree-section-label">Relations (${rels.length})</div>
                ${rels.map(r => `
                  <div class="tree-relation">
                    <span class="tree-relation-arrow">&#8594;</span>
                    <span class="tree-relation-type">${esc(r.relationType)}</span>
                    <span class="tree-relation-arrow">&#8594;</span>
                    <span class="tree-relation-target">${esc(r.to)}</span>
                  </div>
                `).join('')}
              ` : ''}
            </div>
          </div>
        `;
      });
      container.innerHTML = html;
    }

    function handleTreeHeaderClick(el, entityName) {
      selectEntity(entityName);
    }

    function startTreeNameEdit(entityIdx) {
      const entity = graphData.entities[entityIdx];
      const id = `tree-${entity.name.replace(/\s+/g, '-')}`;
      const nameEl = document.getElementById(id + '-name');
      if (!nameEl) return;
      const oldName = entity.name;
      nameEl.innerHTML = `<input class="tree-inline-input" value="${esc(oldName)}" onkeydown="if(event.key==='Enter'){applyTreeNameEdit(${entityIdx}, this.value, '${esc(oldName)}')} if(event.key==='Escape'){renderTree();}" autofocus>`;
      nameEl.querySelector('input').focus();
      nameEl.querySelector('input').select();
    }

    function applyTreeNameEdit(entityIdx, newName, oldName) {
      newName = newName.trim();
      if (!newName || newName === oldName) { renderTree(); return; }
      graphData.entities[entityIdx].name = newName;
      // Update relations referencing old name
      graphData.relations.forEach(r => {
        if (r.from === oldName) r.from = newName;
        if (r.to === oldName) r.to = newName;
      });
      markDirty();
      updateStats();
      rebuildRawLines();
      renderJsonl();
      renderTree();
      renderGraph();
      selectEntity(newName);
    }

    function startObsEdit(entityIdx, obsIdx) {
      const el = document.getElementById(`obs-${entityIdx}-${obsIdx}`);
      if (!el) return;
      const old = graphData.entities[entityIdx].observations[obsIdx];
      el.innerHTML = `<input class="tree-inline-input" value="${esc(old)}" onkeydown="if(event.key==='Enter'){applyObsEdit(${entityIdx}, ${obsIdx}, this.value)} if(event.key==='Escape'){renderTree();}" autofocus>`;
      el.querySelector('input').focus();
    }

    function applyObsEdit(entityIdx, obsIdx, newVal) {
      newVal = newVal.trim();
      if (!newVal) { renderTree(); return; }
      graphData.entities[entityIdx].observations[obsIdx] = newVal;
      markDirty();
      rebuildRawLines();
      renderJsonl();
      renderTree();
    }

    function deleteObs(entityIdx, obsIdx) {
      graphData.entities[entityIdx].observations.splice(obsIdx, 1);
      markDirty();
      updateStats();
      rebuildRawLines();
      renderJsonl();
      renderTree();
    }

    function addObs(entityIdx) {
      const entity = graphData.entities[entityIdx];
      if (!entity.observations) entity.observations = [];
      entity.observations.push('New observation');
      markDirty();
      updateStats();
      rebuildRawLines();
      renderJsonl();
      renderTree();
      // Start editing the new observation immediately
      startObsEdit(entityIdx, entity.observations.length - 1);
    }

    function getEntityIcon(type) {
      const icons = { project: '&#128194;', architecture: '&#127959;', schema: '&#128202;', convention: '&#128214;' };
      return icons[type] || '&#128300;';
    }

    function toggleTree(id) {
      const el = document.getElementById(id);
      const toggle = document.getElementById(id + '-toggle');
      el.classList.toggle('collapsed');
      toggle.innerHTML = el.classList.contains('collapsed') ? '&#9654;' : '&#9660;';
    }

    function esc(s) {
      const d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }

    // --- Graph View ---
    let graphNodeElements = null;
    let graphLinkElements = null;

    function renderGraph() {
      const container = document.getElementById('graph-view');
      container.innerHTML = '';
      graphNodeElements = null;
      graphLinkElements = null;

      if (graphData.entities.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <circle cx="12" cy="12" r="10"/><path d="M8 12h8M12 8v8"/>
            </svg>
            <p>Load a .jsonl file to visualize the knowledge graph</p>
          </div>`;
        return;
      }

      const width = container.clientWidth;
      const height = container.clientHeight;

      const typeColors = { project: '#6c7bf7', architecture: '#f59e0b', schema: '#34d399', convention: '#f472b6' };

      const nodes = graphData.entities.map(e => ({
        id: e.name, type: e.entityType, observations: e.observations || [],
        color: typeColors[e.entityType] || '#8b90a0',
      }));

      const nodeSet = new Set(nodes.map(n => n.id));
      const links = graphData.relations
        .filter(r => nodeSet.has(r.from) && nodeSet.has(r.to))
        .map(r => ({ source: r.from, target: r.to, label: r.relationType }));

      const svg = d3.select(container).append('svg').attr('width', width).attr('height', height);

      svg.append('defs').append('marker')
        .attr('id', 'arrowhead').attr('viewBox', '0 -5 10 10')
        .attr('refX', 28).attr('refY', 0).attr('markerWidth', 6).attr('markerHeight', 6).attr('orient', 'auto')
        .append('path').attr('d', 'M0,-5L10,0L0,5').attr('class', 'graph-arrow');

      const g = svg.append('g');
      svg.call(d3.zoom().scaleExtent([0.3, 4]).on('zoom', (event) => g.attr('transform', event.transform)));

      // Click on background to deselect
      svg.on('click', (event) => {
        if (event.target === svg.node()) { selectedEntity = null; syncSelection(null); }
      });

      const link = g.append('g').selectAll('line').data(links).join('line')
        .attr('class', 'graph-link').attr('marker-end', 'url(#arrowhead)');

      const linkLabel = g.append('g').selectAll('text').data(links).join('text')
        .attr('class', 'graph-link-label').text(d => d.label);

      const node = g.append('g').selectAll('g').data(nodes).join('g')
        .attr('class', 'graph-node')
        .call(d3.drag().on('start', dragstarted).on('drag', dragged).on('end', dragended));

      node.append('circle').attr('r', 18).attr('fill', d => d.color + '22').attr('stroke', d => d.color);
      node.append('text').attr('dy', 32).text(d => d.id.length > 20 ? d.id.slice(0, 18) + '...' : d.id);

      graphNodeElements = node;
      graphLinkElements = link;

      // Tooltip on hover
      const tooltip = document.getElementById('tooltip');
      node.on('mouseenter', (event, d) => {
        const obsHtml = d.observations.slice(0, 4)
          .map(o => `<div>&#8226; ${esc(o.length > 80 ? o.slice(0, 77) + '...' : o)}</div>`).join('');
        const more = d.observations.length > 4 ? `<div style="color:var(--accent)">+${d.observations.length - 4} more...</div>` : '';
        tooltip.innerHTML = `<div class="tooltip-title">${esc(d.id)}</div><div class="tooltip-type">${esc(d.type)}</div><div class="tooltip-obs">${obsHtml}${more}</div>`;
        tooltip.classList.add('visible');
      })
      .on('mousemove', (event) => {
        tooltip.style.left = (event.clientX + 16) + 'px';
        tooltip.style.top = (event.clientY - 8) + 'px';
      })
      .on('mouseleave', () => tooltip.classList.remove('visible'));

      // Click to select
      node.on('click', (event, d) => {
        event.stopPropagation();
        selectEntity(d.id);
      });

      simulation = d3.forceSimulation(nodes)
        .force('link', d3.forceLink(links).id(d => d.id).distance(160))
        .force('charge', d3.forceManyBody().strength(-400))
        .force('center', d3.forceCenter(width / 2, height / 2))
        .force('collision', d3.forceCollide().radius(40))
        .on('tick', () => {
          link.attr('x1', d => d.source.x).attr('y1', d => d.source.y)
              .attr('x2', d => d.target.x).attr('y2', d => d.target.y);
          linkLabel.attr('x', d => (d.source.x + d.target.x) / 2)
                   .attr('y', d => (d.source.y + d.target.y) / 2 - 6);
          node.attr('transform', d => `translate(${d.x},${d.y})`);
        });

      function dragstarted(event, d) { if (!event.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; }
      function dragged(event, d) { d.fx = event.x; d.fy = event.y; }
      function dragended(event, d) { if (!event.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; }

      // Apply current selection to graph
      if (selectedEntity) syncGraphSelection(selectedEntity);
    }

    function syncGraphSelection(name) {
      if (!graphNodeElements || !graphLinkElements) return;

      if (!name) {
        graphNodeElements.classed('selected', false).classed('dimmed', false);
        graphLinkElements.classed('highlight', false).classed('dimmed', false);
        return;
      }

      // Collect connected node names
      const connected = new Set([name]);
      graphData.relations.forEach(r => {
        if (r.from === name) connected.add(r.to);
        if (r.to === name) connected.add(r.from);
      });

      graphNodeElements
        .classed('selected', d => d.id === name)
        .classed('dimmed', d => !connected.has(d.id));

      graphLinkElements
        .classed('highlight', d => {
          const src = typeof d.source === 'object' ? d.source.id : d.source;
          const tgt = typeof d.target === 'object' ? d.target.id : d.target;
          return src === name || tgt === name;
        })
        .classed('dimmed', d => {
          const src = typeof d.source === 'object' ? d.source.id : d.source;
          const tgt = typeof d.target === 'object' ? d.target.id : d.target;
          return src !== name && tgt !== name;
        });
    }

    window.addEventListener('resize', () => { if (graphData.entities.length > 0) renderGraph(); });

    // Auto-load
    const urlParams = new URLSearchParams(window.location.search);
    const autoFile = urlParams.get('file');
    if (autoFile) {
      fetch(autoFile).then(r => r.text()).then(text => {
        document.getElementById('filePath').textContent = autoFile;
        parseAndRender(text);
      }).catch(() => console.error('Failed to auto-load:', autoFile));
    }
  </script>
</body>
</html>
